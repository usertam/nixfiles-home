name: Rebase with staging bot

on:
  issue_comment:
    types: [created]

concurrency:
  group: staging-rebase-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  rebase:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '@usertam-staging-bot rebase')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/create-github-app-token@v2
        id: staging-bot-token
        with:
          app-id: ${{ secrets.STAGING_BOT_APP_ID }}
          private-key: ${{ secrets.STAGING_BOT_PRIVATE_KEY }}

      - name: React with eyes
        run: gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=eyes
        env:
          GH_TOKEN: ${{ steps.staging-bot-token.outputs.token }}

      - uses: actions/checkout@main
        with:
          token: ${{ steps.staging-bot-token.outputs.token }}
          fetch-depth: 0

      - name: Set up staging bot identity
        run: |
          BOT_LOGIN="${{ steps.staging-bot-token.outputs.app-slug }}[bot]"
          git config user.name "$BOT_LOGIN"
          git config user.email "$(gh api "/users/$BOT_LOGIN" --jq '.id')+$BOT_LOGIN@users.noreply.github.com"
        env:
          GH_TOKEN: ${{ steps.staging-bot-token.outputs.token }}

      - name: Rebase and force push
        run: |
          set -euo pipefail
          PR=${{ github.event.issue.number }}

          HEAD_REF=$(gh pr view "$PR" --json headRefName -q .headRefName)
          BASE_REF=$(gh pr view "$PR" --json baseRefName -q .baseRefName)

          trap 'echo "Rebase failed"; git status; git rebase --abort || true' ERR

          git fetch origin "$HEAD_REF":"$HEAD_REF"
          git fetch origin "$BASE_REF"
          git checkout "$HEAD_REF"
          git rebase "origin/$BASE_REF"
          git push --force-with-lease origin "$HEAD_REF"
        env:
          GH_TOKEN: ${{ steps.staging-bot-token.outputs.token }}

      - name: React with rocket on success
        if: success()
        run: gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=rocket
        env:
          GH_TOKEN: ${{ steps.staging-bot-token.outputs.token }}

      - name: React with confused on failure
        if: failure()
        run: gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=confused
        env:
          GH_TOKEN: ${{ steps.staging-bot-token.outputs.token }}
